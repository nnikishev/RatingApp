<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="RatingApp.Views.DatabasesListPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:shapes="clr-namespace:Microsoft.Maui.Controls.Shapes;assembly=Microsoft.Maui.Controls"
    xmlns:models="clr-namespace:RatingApp.Models"
    xmlns:converters="clr-namespace:RatingApp.Converters"
    xmlns:local="clr-namespace:RatingApp.Views"
    Title="Ð‘Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…"
    BackgroundColor="{StaticResource DBL.PageBgColor}"
    Padding="20,16">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:BoolToStatusPillConverter x:Key="BoolToStatusPillConverter"/>
            <converters:BoolToStatusTextConverter x:Key="BoolToStatusTextConverter"/>
            <converters:BoolToStatusTextStyleConverter x:Key="BoolToStatusTextStyleConverter"/>
            
            <!-- ÐŸÐ°Ð»Ð¸Ñ‚Ñ€Ð° -->
            <Color x:Key="DBL.PageBgColor">#F4F6FB</Color>
            <Color x:Key="DBL.CardBg">#FFFFFF</Color>
            <Color x:Key="DBL.PrimaryText">#111827</Color>
            <Color x:Key="DBL.SecondaryText">#6B7280</Color>
            <Color x:Key="DBL.MutedText">#94A3B8</Color>
            <Color x:Key="DBL.Divider">#E5E7EB</Color>

            <Color x:Key="DBL.ChipBg">#F3F4F6</Color>
            <Color x:Key="DBL.ChipText">#4B5563</Color>

            <Color x:Key="DBL.GreenBg">#DDF7EA</Color>
            <Color x:Key="DBL.GreenText">#1F9D6A</Color>
            <Color x:Key="DBL.RedBg">#FEE8E8</Color>
            <Color x:Key="DBL.RedText">#D64545</Color>

            <Color x:Key="DBL.FabStart">#8459FF</Color>
            <Color x:Key="DBL.FabEnd">#6A31FF</Color>

            <Color x:Key="DBL.EditIcon">#3B82F6</Color>
            <Color x:Key="DBL.DeleteIcon">#EF4444</Color>

            <!-- Ð¡Ñ‚Ð¸Ð»Ð¸ Ñ‚ÐµÐºÑÑ‚Ð° -->
            <Style x:Key="DBL.H1" TargetType="Label">
                <Setter Property="TextColor" Value="{StaticResource DBL.PrimaryText}" />
                <Setter Property="FontSize" Value="32" />
                <Setter Property="FontAttributes" Value="Bold" />
            </Style>

            <Style x:Key="DBL.Subtitle" TargetType="Label">
                <Setter Property="TextColor" Value="{StaticResource DBL.SecondaryText}" />
                <Setter Property="FontSize" Value="14" />
            </Style>

            <Style x:Key="DBL.CardTitle" TargetType="Label">
                <Setter Property="TextColor" Value="{StaticResource DBL.PrimaryText}" />
                <Setter Property="FontSize" Value="18" />
                <Setter Property="FontAttributes" Value="Bold" />
            </Style>

            <Style x:Key="DBL.CardSubtitle" TargetType="Label">
                <Setter Property="TextColor" Value="{StaticResource DBL.SecondaryText}" />
                <Setter Property="FontSize" Value="13" />
            </Style>

            <Style x:Key="DBL.InfoText" TargetType="Label">
                <Setter Property="TextColor" Value="{StaticResource DBL.MutedText}" />
                <Setter Property="FontSize" Value="13" />
            </Style>

            <!-- ÐŸÐ»Ð°ÑˆÐºÐ¸-ÑÑ‚Ð°Ñ‚ÑƒÑÑ‹ -->
            <Style x:Key="DBL.PillBase" TargetType="Border">
                <Setter Property="StrokeThickness" Value="0" />
                <Setter Property="Padding" Value="10,6" />
                <Setter Property="StrokeShape">
                    <Setter.Value>
                        <shapes:RoundRectangle CornerRadius="999" />
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="DBL.PillConnected" TargetType="Border" BasedOn="{StaticResource DBL.PillBase}">
                <Setter Property="BackgroundColor" Value="{StaticResource DBL.GreenBg}" />
            </Style>

            <Style x:Key="DBL.PillDisconnected" TargetType="Border" BasedOn="{StaticResource DBL.PillBase}">
                <Setter Property="BackgroundColor" Value="{StaticResource DBL.RedBg}" />
            </Style>

            <Style x:Key="DBL.PillTextConnected" TargetType="Label">
                <Setter Property="TextColor" Value="{StaticResource DBL.GreenText}" />
                <Setter Property="FontSize" Value="12" />
                <Setter Property="FontAttributes" Value="Bold" />
            </Style>

            <Style x:Key="DBL.PillTextDisconnected" TargetType="Label">
                <Setter Property="TextColor" Value="{StaticResource DBL.RedText}" />
                <Setter Property="FontSize" Value="12" />
                <Setter Property="FontAttributes" Value="Bold" />
            </Style>

            <!-- Ð§Ð¸Ð¿Ñ‹ -->
            <Style x:Key="DBL.Chip" TargetType="Border">
                <Setter Property="BackgroundColor" Value="{StaticResource DBL.ChipBg}" />
                <Setter Property="Stroke" Value="#E5E7EB" />
                <Setter Property="StrokeThickness" Value="1" />
                <Setter Property="Padding" Value="10,6" />
                <Setter Property="StrokeShape">
                    <Setter.Value>
                        <shapes:RoundRectangle CornerRadius="10" />
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="DBL.ChipTextStyle" TargetType="Label">
                <Setter Property="TextColor" Value="{StaticResource DBL.ChipText}" />
                <Setter Property="FontSize" Value="12" />
            </Style>

            <!-- ÐšÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ° -->
            <Style x:Key="DBL.CardFrame" TargetType="Frame">
                <Setter Property="BackgroundColor" Value="{StaticResource DBL.CardBg}" />
                <Setter Property="CornerRadius" Value="16" />
                <Setter Property="HasShadow" Value="True" />
                <Setter Property="Padding" Value="16" />
                <Setter Property="Margin" Value="0,10" />
                <Setter Property="Shadow">
                    <Setter.Value>
                        <Shadow Brush="#1A000000" Offset="0,4" Radius="12" Opacity="0.35" />
                    </Setter.Value>
                </Setter>
            </Style>

            <!-- Ð¡Ñ‚Ð¸Ð»Ð¸ Ð´Ð»Ñ Ð¸ÐºÐ¾Ð½Ð¾Ðº Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ -->
            <!-- <Style x:Key="DBL.ActionIcon" TargetType="ImageButton">
                <Setter Property="BackgroundColor" Value="Transparent" />
                <Setter Property="WidthRequest" Value="32" />
                <Setter Property="HeightRequest" Value="32" />
                <Setter Property="CornerRadius" Value="8" />
            </Style> -->
        </ResourceDictionary>
    </ContentPage.Resources>

    <!-- ÐÐ±ÑÐ¾Ð»ÑŽÑ‚ Ð´Ð»Ñ FAB -->
    <AbsoluteLayout>

        <!-- ÐšÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ -->
        <ScrollView AbsoluteLayout.LayoutBounds="0,0,1,1"
                    AbsoluteLayout.LayoutFlags="All">
            <VerticalStackLayout Spacing="16">

                <!-- ÐÐ°Ð²Ð±Ð°Ñ€ -->
                <!-- <Grid ColumnDefinitions="Auto,*,Auto" Padding="0,0,0,8">
                    <ImageButton Source="left-arrow.png" 
                               Command="{Binding GoBackCommand}"
                               Style="{StaticResource DBL.ActionIcon}"
                               WidthRequest="24"
                               HeightRequest="24"/>
                    <Label Grid.Column="1" Text="ÐÐ°Ð·Ð°Ð´ Ð² Ð¼ÐµÐ½ÑŽ" FontSize="14" TextColor="{StaticResource DBL.SecondaryText}" VerticalOptions="Center" />
                </Grid> -->

                <Label Text="Ð‘Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…" Style="{StaticResource DBL.H1}" />
                <Label Text="Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸ÑÐ¼Ð¸" Style="{StaticResource DBL.Subtitle}" />

                <!-- Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð±Ð°Ð· Ð´Ð°Ð½Ð½Ñ‹Ñ… -->
                <CollectionView ItemsSource="{Binding Databases}"
                              EmptyView="ÐÐµÑ‚ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ñ… Ð±Ð°Ð· Ð´Ð°Ð½Ð½Ñ‹Ñ…">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Database">
                            <Frame Style="{StaticResource DBL.CardFrame}">
                                <Grid RowDefinitions="Auto,Auto,Auto,Auto"
                                      ColumnDefinitions="*,Auto"
                                      ColumnSpacing="8" RowSpacing="10">
                                    <Grid.GestureRecognizers>
            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type local:DatabasesListPage}}, Path=BindingContext.ShowDatabaseDetailCommand}"
                                  CommandParameter="{Binding .}"/>
        </Grid.GestureRecognizers>
                                    <!-- Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº Ð¸ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ -->
                                    <Grid Grid.Row="0" Grid.ColumnSpan="2" 
                                          ColumnDefinitions="*,Auto,Auto"
                                          ColumnSpacing="8">
                                        
                                        <Label Grid.Column="0" 
                                               Text="{Binding Name}" 
                                               Style="{StaticResource DBL.CardTitle}" 
                                               VerticalOptions="Center"/>
                                        
                                        <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ -->
                                        <ImageButton Grid.Column="1"
                                                   Source="edit.png"
                                                   Command="{Binding Source={RelativeSource AncestorType={x:Type local:DatabasesListPage}}, Path=BindingContext.EditDatabaseCommand}"
                                                   CommandParameter="{Binding .}"
                                                   Style="{StaticResource DBL.ActionIcon}"
                                                   WidthRequest="20"
                                                    HeightRequest="20"
                                                   BackgroundColor="{StaticResource DBL.EditIcon}"/>
                                        
                                        <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ -->
                                        <ImageButton Grid.Column="2"
                                                   Source="delete.png"
                                                   Command="{Binding Source={RelativeSource AncestorType={x:Type local:DatabasesListPage}}, Path=BindingContext.DeleteDatabaseCommand}"
                                                   CommandParameter="{Binding .}"
                                                   Style="{StaticResource DBL.ActionIcon}"
                                                   WidthRequest="20"
                                                    HeightRequest="20"
                                                   BackgroundColor="{StaticResource DBL.DeleteIcon}"/>
                                    </Grid>

                                    <!-- ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ -->
                                    <Label Grid.Row="1" Grid.ColumnSpan="2"
                                           Text="{Binding Description}"
                                           Style="{StaticResource DBL.CardSubtitle}" />

                                    <!-- Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð‘Ð” -->
                                    <FlexLayout Grid.Row="2" Grid.ColumnSpan="2" 
                                                Direction="Row" 
                                                Wrap="NoWrap" 
                                                AlignItems="Center" 
                                                JustifyContent="Start">
                                        <Border Style="{StaticResource DBL.Chip}" Margin="0,0,10,0">
                                            <HorizontalStackLayout Spacing="6">
                                                <Image 
                                            Source="{Binding IsActive, Converter={converters:BoolToStatusIconConverter}}"
                                            WidthRequest="20"
                                            HeightRequest="20"
                                            VerticalOptions="Center"/>  
                                                <Label Text="{Binding Type}" Style="{StaticResource DBL.ChipTextStyle}" />
                                            </HorizontalStackLayout>
                                        </Border>

                                        <HorizontalStackLayout Spacing="6" Margin="0,0,16,0">
                                            <Label Text="âŽˆ" FontSize="12" TextColor="{StaticResource DBL.MutedText}" VerticalTextAlignment="Center" />
                                            <Label Text="{Binding Host, StringFormat='{0}:{1}'}" 
                                                   Style="{StaticResource DBL.InfoText}" />
                                        </HorizontalStackLayout>

                                        <HorizontalStackLayout Spacing="6">
                                            <Label Text="ðŸ“…" FontSize="12" TextColor="{StaticResource DBL.MutedText}" VerticalTextAlignment="Center" />
                                            <Label Text="{Binding CreatedAt, StringFormat='{0:yyyy-MM-dd}'}" 
                                                   Style="{StaticResource DBL.InfoText}" />
                                        </HorizontalStackLayout>
                                    </FlexLayout>

                                    <!-- Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ -->
                                    <Grid Grid.Row="3" Grid.ColumnSpan="2" ColumnDefinitions="Auto,*,Auto">
                                        <Grid Grid.Column="1" />
                                        
                                        <Label Grid.Column="2" 
                                               Text="{Binding SourcesCount, StringFormat='{0} Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¾Ð²'}" 
                                               Style="{StaticResource DBL.InfoText}" />
                                    </Grid>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <BoxView HeightRequest="24" Opacity="0" />
            </VerticalStackLayout>
        </ScrollView>

        <!-- FAB "+" -->
        <Border
            AbsoluteLayout.LayoutBounds="1,0,56,56"
            AbsoluteLayout.LayoutFlags="PositionProportional"
            StrokeThickness="0">
            <Border.StrokeShape>
                <shapes:RoundRectangle CornerRadius="16" />
            </Border.StrokeShape>
            <Border.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                    <GradientStop Color="{StaticResource DBL.FabStart}" Offset="0.0" />
                    <GradientStop Color="{StaticResource DBL.FabEnd}" Offset="1.0" />
                </LinearGradientBrush>
            </Border.Background>
            <Border.Shadow>
                <Shadow Brush="#33000000" Offset="0,6" Radius="16" Opacity="0.6" />
            </Border.Shadow>
            <Grid>
                <ImageButton Source="add.png"
                           Command="{Binding AddDatabaseCommand}"
                           BackgroundColor="Transparent"
                           WidthRequest="56"
                           HeightRequest="56"/>
            </Grid>
        </Border>

    </AbsoluteLayout>
</ContentPage>